machine:
  node:
    version: 5.3
  timezone:
    America/Chicago
  php:
    version: 7.0.11
  environment:
    # In addition to the environment variables defined in this file, these
    # other variables are defined in the Circle CI UI.
    #
    # TERMINUS_SITE:  Name of the Pantheon site to run tests on, e.g. my_site
    # TERMINUS_TOKEN: The Pantheon machine token
    # GITHUB_TOKEN:   The GitHub personal access token
    # GIT_EMAIL:      The email address to use when making commits
    #
    # TEST_SITE_NAME: The name of the test site to provide when installing.
    # ADMIN_PASSWORD: The admin password to use when installing.
    # ADMIN_EMAIL:    The email address to give the admin when installing.
    #
    # BRANCH: $(echo $CIRCLE_BRANCH | grep -v '^\(master\|[0-9]\+.x\)$')
    # PR_ENV: ${BRANCH:+pr-$BRANCH}
    # CIRCLE_ENV: ci-$CIRCLE_BUILD_NUM
    # DEFAULT_ENV: $(echo ${PR_ENV:-$CIRCLE_ENV} | cut -c -11 | sed 's/-$//')
    DEFAULT_ENV: ci-test
    TERMINUS_ENV: ${TERMINUS_ENV:-$DEFAULT_ENV}
    PATH: $PATH:~/.composer/vendor/bin:~/.config/composer/vendor/bin:tests/scripts

dependencies:
  cache_directories:
    - ~/.composer/cache
    - ~/drupalcon-github-magic/web/themes/basic/node_modules
    - ~/drupalcon-github-magic/web/themes/basic/bin
    - ~/drupalcon-github-magic/web/themes/basic/lib/node_modules
  pre:
    # Notify Slack It Is All Happening
    - php -f scripts/slack/slack_notify.php circle "Code change detected on https://github.com/populist/drupalcon-github-magic."
    - php -f scripts/slack/slack_notify.php circle "Kicking off CircleCI build process _#${CIRCLE_BUILD_NUM}_ in environment _${CIRCLE_ENV}_." TRUE
    # Setup the Proper Git Credentials
    - composer config --global github-oauth.github.com $GITHUB_TOKEN
    - git config --global user.email "$GIT_EMAIL"
    - git config --global user.name "Circle CI"
  override:
    # Setup the Proper Tooling
    - composer global require -n "hirak/prestissimo:^0.3"
    - composer global require -n "consolidation/cgr"
    - cgr "pantheon-systems/terminus:^1"
    - mkdir -p ~/.terminus/plugins
    - composer create-project -n -d ~/.terminus/plugins pantheon-systems/terminus-build-tools-plugin:^1
    # Setup NPM for SASS Compiling for Theme
    - php -f scripts/slack/slack_notify.php grunt "Turning SASS into CSS with Grunt - The JavaScript Task Runner."
    - npm install --prefix web/themes/basic
    - npm install --prefix web/themes/basic -g grunt-cli
    - grunt --gruntfile web/themes/basic/Gruntfile.js sass 
  post:
    # Login with Terminus
    - php -f scripts/slack/slack_notify.php terminus "Logging into Pantheon with Terminus for matt@pantheon.me with a _Machine Token_."
    - php -f scripts/slack/slack_notify.php terminus "Using `terminus --version` for all operations."
    - terminus auth:login -n --machine-token="$TERMINUS_TOKEN"
    # Delete old CI environment
    # - terminus build-env:delete:ci -n "$TERMINUS_SITE" --keep=2 --yes
    # Run Composer to Build the Asssets
    - php -f scripts/slack/slack_notify.php composer "Assembling Site Assets with Composer to Create Build Artifact."
    - composer -n build-assets
    # Wake the Development Site
    - terminus env:wake -n "$TERMINUS_SITE.dev"
    # Setup the CI Testing Environment
    - php -f scripts/slack/slack_notify.php pantheon "Setting up Pantheon Multidev testing environment..."
    - php -f scripts/slack/slack_notify.php pantheon "Using existing Multidev environment - $TERMINUS_ENV" TRUE
    - php -f scripts/slack/slack_notify.php pantheon "Pushing build artifact to Multidev environment" TRUE
    - terminus build-env:create -n "$TERMINUS_SITE.dev" "$TERMINUS_ENV" --yes
    # - terminus build-env:create -n "$TERMINUS_SITE.dev" "$TERMINUS_ENV" --yes --clone-content --db-only 
    # Import Configuration Into Site
    # - terminus drush "$TERMINUS_SITE.$TERMINUS_ENV" -- config-import --yes
test:
  override:
    # Run Behat Testing
    - php -f scripts/slack/slack_notify.php behat "Kicking off Behat testing..."
    - php -f scripts/slack/slack_notify.php behat "Test One: TODO" TRUE
    - php -f scripts/slack/slack_notify.php behat "Test TWO: TODO" TRUE
    # - run-behat

deployment:
  build-assets:
    branch: master
    commands:
      # Merge the Code from the Testing Environment to Master
      - terminus build-env:merge -n "$TERMINUS_SITE.$TERMINUS_ENV" --yes
      # Import Configuration Into Dev Site
      # - terminus drush "$TERMINUS_SITE.dev" -- config-import --yes
